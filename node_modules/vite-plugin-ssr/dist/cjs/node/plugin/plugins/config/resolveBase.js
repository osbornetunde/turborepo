"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveBaseFromUserConfig = exports.resolveBase = void 0;
const utils_1 = require("../../utils");
const pickFirst_1 = require("./pickFirst");
function resolveBase(configs, config) {
    const baseServer = (0, pickFirst_1.pickFirst)(configs.map((c) => c.baseServer)) ?? null;
    const baseAssets = (0, pickFirst_1.pickFirst)(configs.map((c) => c.baseAssets)) ?? null;
    let baseOriginal = config._baseOriginal;
    if (baseOriginal === '/__UNSET__')
        baseOriginal = null;
    (0, utils_1.assert)(baseOriginal === null || typeof baseOriginal == 'string');
    return resolve(baseOriginal, baseServer, baseAssets);
}
exports.resolveBase = resolveBase;
function resolveBaseFromUserConfig(config, configVps) {
    return resolve(config.base ?? null, configVps?.baseServer ?? null, configVps?.baseAssets ?? null);
}
exports.resolveBaseFromUserConfig = resolveBaseFromUserConfig;
function resolve(base, baseServer_, baseAssets_) {
    {
        const wrongBase = (val) => `should start with '/', 'http://', or 'https://' (it is ${val} instead)`;
        (0, utils_1.assertUsage)(base === null || (0, utils_1.isBaseAssets)(base), `vite.config.js#base ${wrongBase(base)}`);
        (0, utils_1.assertUsage)(baseAssets_ === null || (0, utils_1.isBaseAssets)(baseAssets_), `Config \`baseAssets\` ${wrongBase(baseAssets_)}`);
        (0, utils_1.assertUsage)(baseServer_ === null || baseServer_.startsWith('/'), `Config \`baseServer\` should start with a leading slash '/' (it is '${baseServer_}' instead)`);
    }
    if (base) {
        if (base.startsWith('http')) {
            baseAssets_ = baseAssets_ ?? base;
        }
        else {
            baseAssets_ = baseAssets_ ?? base;
            baseServer_ = baseServer_ ?? base;
        }
    }
    const baseServer = baseServer_ ?? '/';
    const baseAssets = baseAssets_ ?? '/';
    (0, utils_1.assert)((0, utils_1.isBaseAssets)(baseAssets));
    (0, utils_1.assert)((0, utils_1.isBaseServer)(baseServer));
    return {
        baseServer,
        baseAssets
    };
}
